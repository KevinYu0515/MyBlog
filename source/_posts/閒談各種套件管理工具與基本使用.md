---
title: 閒談各種套件管理工具與基本使用
toc: true
cover: /gallery/covers/default.jpg
date: 2026-01-21 07:57:50
tags:  ["front-end"]
categories:  ["Develop", "Web"]
excerpt: "主要介紹 npm、npx、yarn、pnpm，並說明為甚麼現在最適合用的是 pnpm。最後提到如果要切換管理器，可以用 corepack 這類工具管理"
---

在前端或 Node.js 專案中，「套件管理工具」幾乎是每天都會接觸的東西。這篇主要快速筆記些常用的套件管理工具 npm、npx、yarn、pnpm，以及 corepack 這類管理「套件管理工具」的使用方式。

## 套件管理工具

### npm、npx

初學 Node.js 時會一起安裝的套件管理工具，用來管理各種第三方套件。但如果要用 npm 執行套件指令需要搭配 package.json 的 scripts 執行命令。安裝套件時會產生 node_modules 並附帶一堆套件，這就是最古早的 Node.js 開發環境。

從 npm 5.25.2 版本開始，增加 npx 指令，可以直接透過這個指令直接執行套件指令。預設情況下會先檢查 node_modules 有沒有存在可執行的套件，如果沒有存在，則 npx 會自動安裝最新版本並執行，使用完後會自動刪除，避免汙染環境。

**Case 1**：使用 npm 執行 vite 指令與用 npx 直接執行

在 npm 需要先在 package.json 的 scripts 寫下以下指令，才能使用 `npm run` 執行
```bash
./node_modules/.bin/vite
```

而使用 npx 就只要這要就能直接執行
```bash
npx vite
```

**Case 2**：忽略專案內的套件版本，使用最新的版本執行

```bash
npx create-vite@latest
```

**Case 3**：使用 npx 切換 node 版本執行

如果只是想要使用不同版本的 node.js 測試，但不想要再透過 nvm 安裝，可以這樣快速測試
```bash
npx node@14.15.0 -v
```

### yarn

相較 npm 又多了以下優點
- 快速安裝：yarn 會快取每次下載的套件，所以不需要反覆重新下載。
- 穩定性：使用 yarn-lock.yaml 表示套件版本紀錄，保證系統轉移時可以更完整的安裝所有依賴套件
- 安全性：執行時會先校驗和驗證每個依賴包的完整性

但由於 yarn2+ (Berry) 改動變化較大，學習成本較高，所以使用比例稍微下降。但還是有學的必要，因為有些套件的相依關係較為奇怪，就算使用之後要說明的 pnpm 可能也無法順利安裝，而使用 yarn 就能解決這些問題。

**安裝方式**

```bash
npm install --global yarn
```

**使用方式**

```bash
# 查詢版本
yarn --version

# 新增依賴套件
yarn add [package]
yarn add [package]@[version]
yarn add [package]@[tag]

# 移除依賴套件
yarn remove [package]

# 升級依賴套件
yarn upgrade [package]
yarn upgrade [package]@[version]
yarn upgrade [package]@[tag]

# 查看套件來源
yarn config get registry

# 綁定套件來源
yarn config set registry https://registry.npmmirror.com

# 刪除套件來源
yarn config delete registry

## 安裝套件
yarn install
```

### pnpm

由於 npm 每次安裝時都是在不同的專案上被使用，所以會重新產生 node_modules 並下載許多重複的套件，而 pnpm 則是採用連結 (symlink) 的方式將所有的專案需要的套件集中在某個資料夾共享，這樣就不會花時間與磁碟空間在重複下載這件事上。當套件版本更新時，也是只會修改有差異的版本，而不會把所有的套件翻新重載。因此 pnpm 帶來的是更有效率的利用空間與減少下載的時間成本。

簡單來說就是有以下優點
- 減少磁碟空間
- 減少下載時間成本
- 支援 monorepo，可以將多個專案只用一個 `.git` 管理版本

**安裝方式**
```bash
# 透過 powrshell 下載
iwr https://get.pnpm.io/install.ps1 -useb | iex

# 透過 npm 安裝
npm install -g pnpm
```

**使用方式**

1. 需要先根據 package.json 產生 pnpm-lock.yaml
```bash
pnpm install
```

2. 安裝套件
```bash
pnpm install --forzen-lockfile
```

3. 管理套件
```bash
# 儲存到 dependencies
pnpm add sax

# 儲存到 devDependencies
pnpm add -D sax

# 儲存到 optionalDependencies
pnpm add -O sax

# Install package globally
pnpm add -g sax

# 從 next 標籤下安裝
pnpm add sax@next

# 安裝指定版本 3.0.0
pnpm add sax@3.0.0

# 移除套件
pnpm remove

# 以樹圖表示所有安裝的套件與相依關係
pnpm list

# 管理設定檔
pnpm config

# 查看全域的套件來源
pnpm config get registry

# 綁定全域的套件來源
pnpm config set registry https://registry.npmmirror.com

# 安裝此專案的臨時來源
npm install --registry https://registry.npmmirror.com
```

4. 升級套件
```bash
# 遵循 package.json 指定的範圍更新所有的依賴項
pnpm up

# 更新所有依賴項，此操作會忽略 package.json 指定的範圍
pnpm up --latest

# 將 foo 更新到v2 上的最新版本
pnpm up foo@2

# 更新 @babel 範圍內的所有依賴項
pnpm up "@babel/*"
```

## 管理套件管理器的管理器

當我們有多個專案或者團隊開發時，有可能會同時存在數個版本的 yarn、pnpm 等工具，那麼就可以使用以下工具幫助我們鎖定，避免使用到不相容的版本。

### corepack

Node.js 內建的工具，使用方式如下

```bash
# 啟用 corepack
corepack enable
```

接著就會產生檔案用來鎖定管理器的版本
```json
{
  "packageManager": "pnpm@9.1.0"
}
```

如果不想用內建的，可以參考 [ni](https://github.com/antfu-collective/ni)

## 其他一些實用指令 (Windows)

- 快速將 node_modules 移除
```powershell
cmd /c "rmdir /s /q node_modules"
```

- 避免檔案鎖定的安全移除方式
```powershell
mkdir empty
robocopy empty node_modules /MIR
rmdir empty
rmdir node_modules
```

- 將多個專案內的 node_modules 刪除
```powershell
Get-ChildItem -Recurse -Directory -Filter node_modules |
ForEach-Object {
  cmd /c "rmdir /s /q `"$($_.FullName)`""
}
```

## 總結

| 面向          | npm               | yarn      | pnpm               |
| ----------- | ----------------- | --------- | ------------------ |
| 安裝速度        | 慢                 | 中         | **快**              |
| 磁碟使用量       | 高                 | 高         | **低**              |
| lock 檔穩定性   | package-lock.json | yarn.lock | **pnpm-lock.yaml** |
| monorepo 支援 | 普通                | 尚可        | **原生支援**           |
| CI 友善度      | 普通                | 普通        | **高**              |
| 隱性依賴風險      | 高（扁平化）            | 高         | **低（嚴格）**          |

我個人看法是，npm 是最一開始的管理工具，所以起碼要知道 npm 在 node.js 生態系的用途與 `package.json` 的關係，而後續專案開始擴張或者要翻新舊專案，可以先過度使用 yarn 來管理，至於已經有點基礎，開發上最主流推薦的非 pnpm 莫屬，畢竟快速又方便，在 CI 方面非常好用。無論如何用什麼工具都還是要記住是否需額外安裝，以及測試版本與現今專案的相容性，如果能搞懂 pnpm 與 npm/yarn 的管理設計上的概念，那想必套件安裝的問題就能迎刃而解。